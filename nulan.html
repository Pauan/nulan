<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      html, body {
        margin: 0px;
        height: 100%;
      }
      #input, #output {
        float: left;
        width: 47%;
        height: 94%;
        padding: 10px;
      }
      #input {
        font-family: monospace;
      }
      #output {
        margin: 0px;
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
    <script src="NULAN.parse.js"></script>

    <script src="lib/NINO.compile.js"></script>
    <script src="lib/NINO.transform.js"></script>
    <script src="lib/NINO.partial.js"></script>

    <script src="NULAN.js"></script>

    <script src="NULAN.macros.js"></script>
    <script src="modes/browser.js"></script>

    <script src="lib/NUIT.serialize.js"></script>

    <textarea autofocus id="input"></textarea>
    <pre id="output"></pre>

    <script>
      ;(function () {
        var i = document.getElementById("input")
          , o = document.getElementById("output")

        function pretty(x) {
          return NUIT.serialize(x, { multiline: true })
        }

        var myEval = eval

        var obs = {}

        console.log = function () {
          obs.print.push([].slice.call(arguments).join(" "))
        }
        /*
        NULAN.options.debug = function (x) {
          obs.$eval.push(x)
        }*/

        function output(s) {
          NULAN.withNewContext(function () {
            obs.parse   = []
            obs.$eval   = []
            obs.compile = []
            obs.eval    = []
            obs.print   = []
            obs.error   = []
            try {
              NULAN.parse(s, function (x) {
                obs.parse.push(x)
                obs.compile.push(NULAN.compile(x))
              })
              obs.compile.forEach(function (x) {
                try {
                  obs.eval.push(myEval(x)) // indirect eval
                } catch (e) {
                  obs.error.push("" + e)
                }
              })
              o.textContent = pretty([//["parse"].concat(a.map(NULAN.toJSON)),
                                      //["compile-eval"].concat(obs.$eval),
                                      ["compile"].concat(obs.compile),
                                      ["eval"].concat(obs.eval),
                                      ["print"].concat(obs.print),
                                      ["error"].concat(obs.error)])
            } catch (e) {
              o.textContent = pretty(["" + e])
            }
          })
        }

        if (localStorage["saved"]) {
          i.value = localStorage["saved"]
          output(i.value)
        }

        i.addEventListener("keyup", function () {
          localStorage["saved"] = this.value
          output(this.value)
        })
      })()
    </script>
  </body>
</html>
