<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="lib/codemirror-3.0/lib/codemirror.css">

    <style type="text/css">
      /*textarea {
        resize: none;
      }*/

      html, body, .CodeMirror, #table, #output, #sandbox {
        box-sizing: border-box;
        -moz-box-sizing: border-box;
        -webkit-box-sizing: border-box;

        margin: 0px;
        border: none;
        width: 100%;
        height: 100%;
      }

      body {
        overflow: hidden;
      }

      #table {
        table-layout: fixed;
        border-collapse: collapse;
        border-spacing: 0px;
      }

      .CodeMirror, #output, #sandbox {
        border: 1px solid black;
      }

      td {
        position: relative;
        padding: 0px;
      }

      #sandbox {
        position: absolute;
        top: -1px;
        left: 1px;
        /*display: block;*/ /* aurgh why does this work?! */
      }
      #output {
        position: absolute;
        top: 1px;
        left: 1px;
      }
/*
      td:first-child {
        padding-left: 0px;
      }
      td:last-child {
        padding-right: 0px;
      }
      tr:first-child td {
        padding-top: 0px;
      }
      tr:last-child td {
        padding-bottom: 0px;
      }*/

      .CodeMirror {
        position: absolute;
        top: 0px;
        left: -1px;
        border-top: none;
        border-bottom: none;
      }

      /*.CodeMirror, #output, #sandbox {
        margin: 1px;
      }*/

      .CodeMirror-scroll, #output, #sandbox {
        overflow: auto;
        /*padding: 5px;*/
      }
/*
      #output, #sandbox {
        white-space: pre-wrap;
        word-wrap: break-word;
      }*/
/*
      #input {
        font-family: monospace;
        outline: none;
      }*/
    </style>
  </head>
  <body>
    <script src="lib/codemirror-3.0/lib/codemirror.js"></script>
    <!--<script src="lib/codemirror-3.0/mode/javascript/javascript.js"></script>-->

    <script src="NULAN.parse.js"></script>

    <script src="lib/NINO.compile.js"></script>
    <script src="lib/NINO.transform.js"></script>
    <script src="lib/NINO.partial.js"></script>

    <script src="NULAN.js"></script>

    <script src="NULAN.macros.js"></script>
    <script src="modes/browser.js"></script>

    <script src="lib/NUIT.serialize.js"></script>

    <script>
      var forms

      ;(function () {
        var i// = document.createElement("textarea")
          , o = document.createElement("pre")
          , sandbox
          , sandboxParent
/*
        i.id = "input"
        i.setAttribute("autofocus", "") // TODO
*/
        o.id = "output"

        function editor(x) {
          x = CodeMirror(x, {
            value: localStorage["saved"],
            lineWrapping: true,
            lineNumbers: true,
            autofocus: true
          })

          x.on("change", function (x, o) {
            var s = x.getValue()
            localStorage["saved"] = s
            process(x, s)
          })

          x.on("cursorActivity", function (x) {
            output(x, o)
          })

          process(x, localStorage["saved"])
        }

        var lines = []

        // http://codemirror.net/demo/widget.html
        function error(oEditor, line, message) {
          var x = document.createElement("div")
          x.style.fontFamily = "arial"
          x.style.fontSize = "70%"
          x.style.background = "#ffa"
          x.style.color = "#a00"
          x.style.padding = "2px 5px 3px"

          var y = document.createElement("span")
          y.textContent = "!!"
          y.style.color = "white"
          y.style.backgroundColor = "red"
          y.style.fontWeight = "bold"
          y.style.borderRadius = "50%"
          y.style.padding = "0 3px"
          y.style.marginRight = "7px"

          x.appendChild(y)
          x.appendChild(document.createTextNode(message))
          lines.push(oEditor.addLineWidget(line - 1, x))
        }

        function output(oEditor, o) {
          var output = {
            error:        [],
            prints:       [],
            eval:         [],
            compile:      [],
            compileEvals: [],
            parse:        []
          }

          var start = oEditor.getCursor(true).line + 1
            , end   = oEditor.getCursor(false).line + 1

          forms.forEach(function (x) {
            if ("error" in x) {
              output.error.push(x.error)
            }
            if (x.start <= end && x.end >= start) {
              output.prints.push.apply(output.prints, x.prints)
              if ("eval" in x) {
                output.eval.push(x.eval)
              }
              if ("compile" in x) {
                output.compile.push(x.compile)
              }
              output.compileEvals.push.apply(output.compileEvals, x.compileEvals)
              if ("parse" in x) {
                output.parse.push(x.parse)
              }
            }
          })

          var r = []

          if (output.error.length) {
            r.push(["error"].concat(output.error))
          }
          if (output.prints.length) {
            r.push(["print"].concat(output.prints))
          }
          if (output.eval.length) {
            r.push(["eval"].concat(output.eval.map(pretty)))
          }
          if (output.compile.length) {
            r.push(["compile"].concat(output.compile))
          }
          if (output.compileEvals.length) {
            r.push(["compile-eval"].concat(output.compileEvals))
          }
          if (output.parse.length) {
            r.push(["parse"].concat(output.parse.map(function (x) {
              return prettyParse(x)
            })))
          }

          o.textContent = NUIT.serialize(r, { multiline: true })
        }

        function prettyParse(x) {
          // TODO: code duplication with pretty
          if (Array.isArray(x)) {
            return "(" + withIndent(function () {
                           var seen
                           return x.map(function (x) {
                             if (Array.isArray(x)) {
                               seen = true
                             }
                             if (seen) {
                               return "\n" + spaces() + prettyParse(x)
                             } else {
                               return prettyParse(x)
                             }
                           }).join(" ")
                         }) + ")"
          } else if (x instanceof NULAN.Wrapper) {
            return prettyParse(x.value)
          } else if (typeof x === "string") {
            return "\"" + x + "\"" // TODO replace " inside the string with \"
          } else {
            return "" + x
          }
        }
/*
        function coords() {
          output(this, o)
        }

        // TODO: onselectstart onselectionchange
        i.addEventListener("select", coords, true)
        // TODO: keydown and mousedown fire before selection changes, ugh
        i.addEventListener("keyup", coords, true)
        i.addEventListener("mouseup", coords, true)
*/
        //var myEval = eval

        var indent = 0

        function withIndent(f) {
          var old = indent
          indent += 2
          try {
            var x = f()
          } finally {
            indent = old
          }
          return x
        }

        function spaces() {
          return new Array(indent + 1).join(" ")
        }

        function prop(x) {
          if (/^[$_a-zA-Z][$_a-zA-Z0-9]*$/.test(x)) {
            return x
          } else {
            return pretty(x)
          }
        }

        function pretty(x) {
          // TODO: a bit ew
          if (Array.isArray(x)) {
            return "[" + withIndent(function () {
                           var seen
                           return x.map(function (x) {
                             if (Array.isArray(x)) {
                               seen = true
                             }
                             if (seen) {
                               return "\n" + spaces() + pretty(x)
                             } else {
                               return pretty(x)
                             }
                           }).join(", ")
                         }) + "]"
          /*} else if (x instanceof Object && typeof x !== "function") {
            return "{\n" + withIndent(function () {
                             return Object.getOwnPropertyNames(x).map(function (s) {
                               return spaces() + prop(s) + ": " +
                                        (x[s] === x
                                          ? "[Circular]"
                                          : pretty(x[s]))
                             }).join(",\n")
                           }) + "\n" + spaces() + "}"*/
          } else if (typeof x === "string") {
            // TODO
            return "\"" + x + "\""
          } else {
            return "" + x
          }
        }

        function process(oEditor, s) {
          lines.forEach(function (x) {
            oEditor.removeLineWidget(x)
          })
          lines = []

          if (sandbox) {
            sandboxParent.removeChild(sandbox)
          }
          sandbox = document.createElement("iframe")
          sandbox.id = "sandbox"
          sandboxParent.appendChild(sandbox)

          var myEval = sandbox.contentWindow.eval

          NULAN.withNewContext(function () {
            forms = []

            NULAN.parse(s, function (x, start, end) {
              var o = {
                compileEvals: [],
                prints:       [],
                parse:        x,
                start:        start,
                end:          end
              }

              NULAN.options.debug = function (x) {
                o.compileEvals.push(x)
              }

              sandbox.contentWindow.console.log = function () {
                o.prints.push([].slice.call(arguments).join(" "))
              }

              try {
                o.compile = NULAN.compile(x)
                o.eval = myEval(o.compile) // indirect eval
              } catch (e) {
                if (e instanceof NULAN.Error) {
                  error(oEditor, e.line, e.originalMessage)
                } else {
                  error(oEditor, start, "" + e)
                }

                //o.error = "" + e
                //o.textContent = print(["" + e])
              }

              forms.push(o)
            })

            output(oEditor, o)
          })
        }

        /*if (localStorage["saved"]) {
          i.value = localStorage["saved"]
          process(i.value)
        }

        i.addEventListener("input", function () {
          //if (this.value !== localStorage["saved"]) {
          localStorage["saved"] = this.value
          process(this.value)
          //}
        })*/

        ;(function (tab) {
          tab.id = "table"

          document.body.appendChild(tab)

          var y

          ;(function (x) {
            y = x.insertCell(0)
            y.width = "50%"
            y.height = "50%"
            y.appendChild(o)
          })(tab.insertRow(0))

          ;(function (x) {
            sandboxParent = y = x.insertCell(0)
            y.width = "50%"
            y.height = "50%"

            y = x.insertCell(0)
            y.width = "50%"
            y.setAttribute("rowspan", "2")
            editor(y)
          })(tab.insertRow(0))
        }(document.createElement("table")))
      })()
    </script>
  </body>
</html>
