(IMPORT (file "../list")
| transform
| List)

(IMPORT (file "../text")
| Text)

(IMPORT (file "../null")
| Null)

(IMPORT (file "../task")
| Task)

(IMPORT (file "../maybe")
| Maybe)

(IMPORT (file "../observe")
| $observe
| $observe-list)


(TYPE Root)
(TYPE Event)
(TYPE Class)


(TYPE Style
| (*style Text Text)

| (REQUIRE ($observe a)
    (*style-observe Text (a (Maybe Text)))))


(TYPE Attribute
| (*attribute-text Text Text)

| (*attribute-classes (List Class))

| (*attribute-event Text (-> Event (Task Null)))

| (*attribute-styles (List Style))

| (REQUIRE ($observe a)
    (*attribute-text-observe Text (a (Maybe Text))))

| (REQUIRE ($observe a)
    (*attribute-classes-observe (a (List Class)))))


(TYPE HTML
| (*parent-list Text (List Attribute) (List HTML))

| (*child Text (List Attribute))

| (*text Text)

| (REQUIRE ($observe-list a)
    (*parent-observe-list Text (List Attribute) (a HTML)))

| (REQUIRE ($observe a)
    (*text-observe (a Text))))


(UNSAFE-FFI-LOAD { target <= javascript-browser
                 | file <= "../../ffi/browser/dom.js" }
| make_class :: (-> (List Style) Class)
# TODO make this into a Task ?
| root :: Root
| render :: (-> Root HTML (Task Null)))


(REWRITE-RULE
| (CLASS ~name ~@a)
    &(CONSTANT
     | ~name :: Class
     | ~name <= (make_class [ ~@a ])))


(EXPORT-CONSTANT
| event <= *attribute-event

| attr <= *attribute-text
| attr-observe <= *attribute-text-observe

| classes <= *attribute-classes
| classes-observe <= *attribute-classes-observe

| styles <= *attribute-styles

| style <= *style
| style-observe <= *style-observe

| parent <= *parent-list
| parent-observe <= *parent-observe-list

| text <= *text
| text-observe <= *text-observe

| child <= *child)

(EXPORT
| Root
| Class
| Attribute
| Style
| HTML

| class <= make_class
| CLASS

| root
| render)
