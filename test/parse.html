<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
  </head>
  <body>
    <script src="../lib/requirejs/require.js"></script>
    <script>
      require(["../src/data", "../src/parse", "../src/tokenize", "../src/builtins", "../src/print", "../lib/util/iter", "../src/state"], function (data, parse, tokenize, builtins, print, iter, state) {
        function tokens(o) {
          var r = []
          while (o.has()) {
            r.push(o.read())
          }
          console.log(print.array(r))
        }
        
        function parsed(o) {
          iter.each(o, function (x) {
            console.log(print.normal(parse.parse(parse.indent(x))))
          })
        }

        function test(a) {
          state.vars.reset(builtins.vars, function () {
            a.forEach(function (x) {
              var o = tokenize.tokenize(x)
              try {
                parsed(o)
              } catch (e) {
                if (e instanceof data.Error) {
                  console.error(e.message)
                } else {
                  throw e
                }
              }
            })
          })
        }

        test([
          "-----FIX-----",
          
          "[-> a b c\n   qux corge\n -> a b c\n   testing]",
          
          "vars drop1 = -> f\n  f 1 2 3",
          
          "| 1\n|\n| 2",
          "| 1\n| 2\n|",
          
          "-----NORMAL-----",
          
          "1 2 3\n\n4 5 6\n\n\n7 8 9",
          
          "|",
          "| 1\n  2\n| 3",
          "foo\n  | 1\n    2\n  | 3",
          "foo\n  | 1\n     2\n  | 3",
          
          "foo\n  | 1\n  | 2\n  | 3",
          "foo\n  | 1\n\n  | 2\n  | 3",
          
          "$mac foo -> (`'\"' \"foo\" bar)\n  qux",
          "$mac foo -> (`\"@\"foo\"@bar\")\n  qux",
          "$mac foo -> (`\"foo@bar\")\n  qux",
          "$mac foo -> \"foo@bar\"\n  qux",
          
          "\"@\"foo\"@bar\"",
          "\"@foo@bar\"",
          
          "foo 1 2; 3 4",
          
          "[:-> a b c\n   qux corge\n :-> a b c\n   testing]",
          "[:-> a b c\n    qux corge\n :-> a b c\n    testing]",
          "[:-> a b c\n   qux corge\n :-> a b c\n   testing\n]",
          "[foo 1 + 2 bar]",
          "[| 1\n | 2\n | 3]",
          "[`foo 1 2 3\n    4 5 6\n test]",
          "[\n  foo = 1\n  bar = 2\n]",
          "[(foo 1 2\n    bar 3 4)\n test]",
          
          "((foo 1 2\n    bar 3 4)\n test)",
          
          "[]",
          "[1]",

          "foo",
          "1 * 2 + 3",

          " w/var\n   foo\n     1\n       2\n  bar\n  qux\ncorge",
          "w/var foo = qux 1 2 3\n             4 5\n      bar = test\n            1\n  uh huh",
          "w/var foo = bar 1 2 3\n             uh huh\n            testing",
          "        testing\n  `1 2 3",
          
          "foo = 1",
          "foo =\n    1",
          "foo =\n     1",
          "foo =\n     bar 1 2\n  qux",
          
          "foo [ a\n b\n c\n] = testing\n  yesno",
          "foo [ a\n b\n c\n] = testing\n      yesno",
          
          "vars drop1 = -> f f 1 2 3",
          "vars drop1 = -> f\n               f 1 2 3",
          "vars drop1 =\n  -> f\n    f 1 2 3",
          
          "vars foo = [1 2 3]",
          "vars foo = [\n  1\n  2\n  3\n]",
          "vars foo = [\n  bar 1 2 3\n    testing 4\n  qux 2 3 4\n  yes no 5\n]",
          "vars foo = [ foo 1 2 3\n            bar 2 3 4 ]",

          "1 - 2",
          "a = 1",
          "a <= 1",
          "1;",
          ":1",
          "foo.bar",
          "~foo",
          "`foo",
          
          "->",
          "| 1 2",
          "| 1\n| 2",
          "| 1 2\n| 3 4",
          
          "(1 2 3)",
          "(1\n 2\n 3)",
          "(1\n  2\n  3)",

          "foo\n  1 2 3",
          ":foo\n   1 2 3",
          "(foo\n  1 2 3)",
          ":(foo\n    1 2 3)",
          
          ",foo",
          ",@foo",
          ",@(foo)",
          ",@:foo",
          
          "`foo ,bar qux",
          
          "| vars ,@(args.map -> [x] x)\n| ,@args.map -> [x y]\n      `(`x).macex <= drop1 y\n| ()",
          "| vars ,@(args.map -> [x] x)\n| ,@:args.map -> [x y]\n      `(`x).macex <= drop1 y\n| ()",
          "| vars ,@(args.map -> [x] x)\n| ,@(args.map -> [x y]\n      `(`x).macex <= drop1 y)\n| ()",
          
          "import\n  { foo bar qux }\n  { corge yesno }",
          "import { foo bar qux } = \"qux\"",
          "import { foo bar qux } = \"qux@2\"",
          "import { (foo2 = foo) bar (qux2 = qux) } = \"qux\"",
          "import { foo bar qux } = \"qux\"\n       { test }        = \"corge\"",
          "import { foo bar qux } = \"qux@2\"\n       { test }        = \"corge\"",
          "import { foo2 = foo\n         bar\n         qux2 = qux } = \"qux\"\n       { test }       = \"corge\"",

          "foobar",
          "foobar quxcorge",
          "1 + 2 * 3",
          "1 * 2 + 3",

          "[]",
          "[1 2 3]",
          "[(foo 1 2) (bar 3 4)]",
          "[(foo (1 2)) (bar (3 4))]",
          "[(foo (1 2)) 3 4]",
          "[1 (foo (2 3)) 4]",

          "[-> a b c\n   qux corge\n testing]",

          "{}",
          "{ foo bar qux }",
          "{ foo = 1 }",
          "{ foo = bar = 1 }",
          "{ foo = bar = 1\n  qux = corge = 2 }",
          "{ foo = 1 bar = 2 }",
          "{ (foo = 1) (bar = 2) }",
          "{ foo = 1\n  bar = 2 }",
          
          "test { foo = 1\n       bar = 2 }",
          "test {\n  foo = 1\n  bar = 2\n}",
          "$syntax-rule \"test\" {\n  parse = -> l s r\n    x\n}",
          "$syntax-rule \"test\" {\n  parse = -> l s r\n            x\n}",

          "'foo' bar qux",
          "'('foo bar qux",
          "foo'\\\\'bar",
          "foo' 'bar' 'qux corge",
          "'foo'' 'bar' 'qux corge",
          "' 'foo' 'bar' 'qux corge",
          "'\n'foo'\n'bar'\n'qux corge",
          "'\n' foo '\n' bar '\n' qux corge",
          "(')'test)yes",
          "foo bar\n  qux corge\ntesting",
          "foo bar\n  1 + 2\nyesno",
          "foo bar\n  qux\n  corge",

          "1 +\n  2",

          "foo: bar",
          "foo: bar qux corge",
          "foo:\n  bar qux corge",
          "foo: bar qux\n       corge",
          "foo: bar       qux corge",
          "foo: bar\n  qux corge",
          "foo <= bar",
          "foo <= bar qux corge",
          "foo <= bar qux\n         corge\n  1 2",
          "foo <= bar\n  qux corge",
          "w/var foo = qux 1\n              2\n  test corge",
          "foo = bar",
          "foo = bar 2",
          "foo <= bar <= qux",

          "foo | bar\n    | qux\n    | corge",
          "foo | bar 1\n    | qux 2\n    | corge 3",
          "foo | bar 1\n        2 3\n    | qux 2\n        3 4\n    | corge 3\n        4 5",
          "foo | bar\n    | qux\n   | corge",

          "foo == bar + 2",
          "foo && bar || qux && corge || nou",

          "{ foo -> bar qux\n    1 + 2\n  test -> yes no\n    1 + 2 }",
          "{ foo = 1\n  bar = 2 }",
          "{ foo -> 1\n  bar -> 2 }",
          "{ foo = -> 1\n  bar = -> 2 }",
          "{ foo 1 bar 2 }",
          "{ foo 1\n  bar 2 }",
          "{ foo = 1 bar = 2 }",
          "{ foo = 1\n  bar = 2 }",
          "{ foo }",

          "`foo",
          "`{foo = 1 bar = 2}",
          "`[foo 1 2 3]",
          "`foo\n test",
          "`foo\n  test",

          "foo bar -> qux corge\n  testing",

          "if null? 1\n   2\n   3",
          "if: null? 1\n     2\n     3",
          "if: null? 1\n    2\n    3",
          "if: null? 1\n   2\n   3",
          "if: null? 1\n  2\n  3",

          "()",
          "1 + ()",
          "1 + \"foo@bar\"",
          "1 + | 2\n    | 3\n    | 4",
          "(1)",
          "(1 2 3)",
          "1 + '('",
          "1 + ('(')",
          "((foo (qux 1 2)) (bar 2))",
          "(foo 1\nbar 2)",
          "(foo 1\n bar 2)",
          "(foo 1\n bar 2\n  qux 3)",
          "(foo 1\n bar 2\n qux 3)",
          "foo 1\n  bar 2\n  qux 3",
          "(foo 1\n  bar 2\n  qux 3)",
          "(foo 1\n  bar 2\n   qux 3)",
          "(foo\n bar\n qux)",
          "1 (foo\n bar\n qux) 2",

          "[foo 1\n bar 2]",
          "[foo 1 2 3]",
          "[foo 1 + 2 3]",
          "[foo\n1 2 3]",
          "[1 2\n 3 4\n 5 6]",
          "[foo\n1 + 2\n  3]",
          "foo[1 2 3]",
          "foo[1]",
          "foo.bar",
          "1.50",
          "foo [1]",
          "0.1.foo",
          "0.foo",
          "foo.\"bar\"",

          "foo",
          "foo;",

          "~foo",
          "~ foo",
          "foo ~= bar",

          "1#foo bar",
          "#| foo |#[1 2 3]",
          "#| foo #| bar |#|#[1 2 3]",
          
          "`1 2 3",
          "`(1 2 3)",
          "(` 1 2 3)",

          "\"foo bar qux\"",
          "\"foo @bar qux\"",
          "\"foo @1 + 2 qux\"",
          "\"foo @(1 + 2) qux\"",
          "\"foo @(1 + 2 3 + 4) qux\"",
          "\"foo @\"bar\" qux\"",
          "\"foo @\"@bar\" qux\"",
          "\"foo@\n test yesno\"",
          "\"foo@\n (test 1\n   2 3) yesno\"",
          "\"foo@(test 1\n       (2 3)) yesno\"",
          "  \"foo bar\n   qux corge\n   testing yes\n    yes\"",
          "uh huh \"foo bar\n        qux corge\n        testing yes\n         yes\"",
          "\"@foo\"",
          "\"foo\\\"bar\"",
          "\"foo\\\\bar\"",
          "\"foo\\\n bar\"",
          "\"foo\\\n  bar\"",
          "\"foo\"[0]",
          "\"foo\".0",
          
          "[ 1 2 \"foo bar\n       qux corge\n       testing yes\n        yes\" ]",
          
          "''",
          "'foo'",
          "'\\n'",
          "'\n'",
          "'\\\\'",
          "'\\''",
          "'\\\n'",
          "'\\\n test'",
          "'<=' 1 2 3",
          "`foo 'it' testing",
          "`foo ,'it' testing",

          "if (var a = 1) a a",
          "if (var a = 1)\n  a\n  a",

          "-> [@b] 1",

          "var _ = 1",
          "_",

          "$eval\n  | vars drop1 = -> f\n      -> [_ @args] (f @args)\n  | ()",
          "$eval\n  | vars drop1 =\n      -> f\n        -> [_ @args] (f @args)\n  | ()",

          "(`$macs).&macro <= drop1 -> @args\n  `$eval",

          "`(\\=)",
          "`('=')",
          
          "'\"'",

          "$mac words -> @args\n  `[,@(args.&map -> x \"@x\")]",
          "$mac str -> @args\n  `'\"' ,@args",
          "$mac str -> @args\n  `\"@(,@args)\"",
          
          "-----ERRORS-----",

          "- 1",
          "+ 1",
          "1 -",
          "1 + - 2",
          "1 + 2 -",

          "<= 1",
          "a <=",
          "<=",

          ";",
          ":",
          
          "= 1",
          "a =",
          "=",

          ".bar",
          "foo.",
          
          "~",
          "`",
          
          "(1 2 3}",
          "(1 2 3",
          "1 2 3)",
          
          "1 + (()",
          "1 + ())",
          "1 + ())2",
          
          "#| foo",
          "#| foo #| bar |#",
          "#| foo #| bar",
          
          "`(=)",
          
          "\"foo\\bbar\"",
          "\"foo bar qux corge",
          "  \"foo bar\nqux corge\n   testing yes\n    yes\"",
          "  \"foo bar\n qux corge\n   testing yes\n    yes\"",
          "  \"foo bar\n  qux corge\n   testing yes\n    yes\"",
          
          "\"foo @+ qux\"",
          "\"foo @(+ 2) qux\"",
          "\"foo @(1 +) qux\"",
          
          "'foo",
          "'\\b'",
        ])
      })
    </script>
  </body>
</html>
